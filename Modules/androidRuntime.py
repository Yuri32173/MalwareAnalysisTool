#!/usr/bin/python3

import os
import sys
import time
from prompt_toolkit import prompt
from prompt_toolkit.completion import WordCompleter
from rich import print
from rich.table import Table
import frida
from colorama import Fore, Style

# Colors
red = Fore.LIGHTRED_EX
cyan = Fore.LIGHTCYAN_EX
white = Style.RESET_ALL
green = Fore.LIGHTGREEN_EX
yellow = Fore.LIGHTYELLOW_EX
magenta = Fore.LIGHTMAGENTA_EX

# Legends
info_symbol = f"{cyan}[{red}*{cyan}]{white}"
error_symbol = f"{cyan}[{red}!{cyan}]{white}"

# Gathering Qu1cksc0pe path variable
sc0pe_path = open(".path_handler", "r").read()

# Device manager
device_manager = frida.get_device_manager()
devices = device_manager.enumerate_devices()

def get_devices(devices) -> list:
    # Table
    dev_table = Table()
    dev_table.add_column("[bold green]Number", justify="center")
    dev_table.add_column("[bold green]Device ID", justify="center")
    dev_table.add_column("[bold green]Device Name", justify="center")
    dev_table.add_column("[bold green]Connection Type", justify="center")

    # Parsing device information
    if devices:
        numbers = []
        for count, dd in enumerate(devices, start=1):
            dev_table.add_row(str(count), str(dd.id), str(dd.name), str(dd.type))
            numbers.append(str(count))
        print(dev_table)
        return numbers

# Main execution
if __name__ == "__main__":
    device_numbers = get_devices(devices)
    
    # Prompt for device selection
    if device_numbers:
        device_completer = WordCompleter(device_numbers)
        selected_device = prompt(f"{info_symbol} Select a device: ", completer=device_completer)
        if selected_device in device_numbers:
            selected_device_index = int(selected_device) - 1
            selected_device_id = devices[selected_device_index].id
            print(f"{info_symbol} Selected device: {devices[selected_device_index].name}")
        else:
            print(f"{error_symbol} Invalid device selection.")
def GetPackages(index) -> list:
    # Tables
    appTable = Table()
    appTable.add_column("[bold green]Application Name", justify="center")
    appTable.add_column("[bold green]Package Name", justify="center")

    # Parsing application informations
    try:
        applications = devices[int(index)-1].enumerate_applications()
        package_list = []
        for app in applications:
            appTable.add_row(str(app.name), str(app.identifier))
            package_list.append(app.identifier)
        print(appTable)
        return package_list
    except frida.ServerNotRunningError:
        print(f"{errorS} Unable to connect to remote frida-server.\n")
        sys.exit(1)

def GetScripts() -> list:
    # Tables
    scriptTable = Table()
    scriptTable.add_column("[bold green]Description", justify="center")
    scriptTable.add_column("[bold green]File Name", justify="center")

    # Gathering and parsing script files
    menu_content = os.listdir(f"{sc0pe_path}/Systems/Android/FridaScripts/")
    sc_list = []
    for sc in menu_content:
        scname = sc.replace("-", " ")
        scriptTable.add_row(str(scname.replace(".js", "").upper()), str(sc.replace(".js", "")))
        sc_list.append(sc.replace(".js", ""))
    print(scriptTable)
    return sc_list

def FridaMain():
    try:
        # Device enumeration
        print(f"{infoS} Enumerating devices...")
        device_completer = WordCompleter(GetDevices(devices))
        device_index = prompt("\n>>> Select a device: ", completer=device_completer)

        # Enumerating installed applications
        print(f"\n{infoS} Enumerating installed applications...")
        app_completer = WordCompleter(GetPackages(index=device_index))
        target_application = prompt("\n>>> Enter package name: ", completer=app_completer)

        # Script menu
        print(f"\n{infoS} Gathering available FRIDA scripts...")
        script_completer = WordCompleter(GetScripts())
        use_script = prompt("\n>>> Enter file name: ", completer=script_completer)
    except:
        print(f"{errorS} Program terminated.")
        sys.exit(1)

    # Process management
    try:
        process = devices[int(device_index)-1].spawn([target_application])
        devices[int(device_index)-1].resume(process)
        time.sleep(1)
    except frida.NotSupportedError:
        print(f"{errorS} An error occured while attach on remote device. Is frida-server running on remote device?\n")
        sys.exit(1)

    # Session handling
    session = devices[int(device_index)-1].attach(process)
    script = session.create_script(open(f"{sc0pe_path}/Systems/Android/FridaScripts/{use_script}.js").read())
    script.load()
    while True:
        if session.is_detached is False:
            input()
        else:
            print(f"{errorS} Process detached.")
            sys.exit(1)

# Execution
FridaMain()
